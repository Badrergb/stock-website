<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8">
  <title>рокроЩрпНроХрпБ роорпЗро▓ро╛ро│ро░рпН (Stock Manager)</title>
  <script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase, ref, get, set, update, onValue
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyARqMZuRIIIll7yXIC6yKQaRpHdO9vAZm4",
      authDomain: "pangu-stock-manager.firebaseapp.com",
      databaseURL: "https://pangu-stock-manager-default-rtdb.firebaseio.com",
      projectId: "pangu-stock-manager",
      storageBucket: "pangu-stock-manager.appspot.com",
      messagingSenderId: "480460883375",
      appId: "1:480460883375:web:eed86845204cdf8f64db5a",
      measurementId: "G-BGPWQ5YE9H"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Load dropdown options from Firebase
    window.onload = function () {
      const countSelect = document.getElementById("count");
      const designSelect = document.getElementById("design");
      const yardSelect = document.getElementById("yard");

      get(ref(db, "stock")).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          const counts = new Set();
          const designs = new Set();

          for (let key in data) {
            const row = data[key];
            counts.add(row["ро╡ .роОрогрпН"]);
            designs.add(row["родро░роорпН"]);
          }

          counts.forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.text = val;
            countSelect.appendChild(opt);
          });

          designs.forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.text = val;
            designSelect.appendChild(opt);
          });

          for (let i = 6; i <= 10; i++) {
            const opt = document.createElement("option");
            opt.value = `${i} роХрпЖроЬроорпН`;
            opt.text = `${i} роХрпЖроЬроорпН`;
            yardSelect.appendChild(opt);
          }
        } else {
          alert("Stock data not found.");
        }
      });
    };

    window.updateStock = function (action) {
      const count = document.getElementById("count").value;
      const design = document.getElementById("design").value;
      const yard = document.getElementById("yard").value;
      const qty = parseInt(document.getElementById("quantity").value);
      const user = "default_user"; // You can replace this with login user session

      if (!count || !design || !yard || isNaN(qty) || qty <= 0) {
        alert("родропро╡рпБроЪрпЖропрпНродрпБ роЕройрпИродрпНродрпБ родроХро╡ро▓рпИропрпБроорпН роЪро░ро┐ропро╛роХ роЙро│рпНро│ро┐роЯро╡рпБроорпН.");
        return;
      }

      // Find the matching item
      get(ref(db, "stock")).then(snapshot => {
        if (snapshot.exists()) {
          let keyFound = null;
          let itemData = null;
          snapshot.forEach(child => {
            const data = child.val();
            if (data["ро╡ .роОрогрпН"] == count && data["родро░роорпН"] == design) {
              keyFound = child.key;
              itemData = data;
            }
          });

          if (!keyFound) {
            alert("рокрпКро░рпБро│рпН роХрогрпНроЯрпБрокро┐роЯро┐роХрпНроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ.");
            return;
          }

          let currentQty = parseInt(itemData[yard] || 0);
          const minStock = parseInt(itemData["роХрпБро▒рпИроирпНродрокроЯрпНроЪ рокроЩрпНроХрпБ роиро┐ро▓рпИ"]);

          if (action === "Sell") {
            if (currentQty < qty) {
              alert("рокроЩрпНроХрпБ рокрпЛродро╡ро┐ро▓рпНро▓рпИ.");
              return;
            }
            currentQty -= qty;
          } else {
            currentQty += qty;
          }

          const updates = {};
          updates[`stock/${keyFound}/${yard}`] = currentQty;

          update(ref(db), updates).then(() => {
            const log = {
              USERNAME: user,
              COUNT: count,
              DESIGN: design,
              YARD: yard,
              QUANTITY: qty,
              ACTION: action,
              DATE: new Date().toLocaleString("ta-IN")
            };

            const logKey = Date.now();
            set(ref(db, `StockHistory/${logKey}`), log);

            if (action === "Sell" && currentQty < minStock) {
              alert("роОроЪрпНроЪро░ро┐роХрпНроХрпИ: рокроЩрпНроХрпБ роХрпБро▒рпИроирпНрод роиро┐ро▓рпИропро┐ро▓рпН роЙро│рпНро│родрпБ!");
            } else {
              alert("рокроЩрпНроХрпБ ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ рокрпБродрпБрокрпНрокро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ!");
            }
          });
        } else {
          alert("рокроЩрпНроХрпБ родро░ро╡рпБроХро│рпН роПро▒рпНро▒ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ.");
        }
      });
    };
  </script>
</head>
<body>
  <h1>ЁЯУж рокроЩрпНроХрпБ роорпЗро▓ро╛ро│ро░рпН</h1>
  <label>ро╡ .роОрогрпН (Count):</label>
  <select id="count"></select><br><br>

  <label>родро░роорпН (Design):</label>
  <select id="design"></select><br><br>

  <label>ро░роХроорпН (Yard):</label>
  <select id="yard"></select><br><br>

  <label>роЕро│ро╡рпБ (Quantity):</label>
  <input type="number" id="quantity" min="1"><br><br>

  <button onclick="updateStock('Sell')">ро╡ро┐ро▒рпНрокройрпИ роЪрпЖропрпН (Sell)</button>
  <button onclick="updateStock('Purchase')">ро╡ро╛роЩрпНроХрпБ (Purchase)</button>
</body>
</html>
